This is a fork of [pb3sol](https://github.com/umegaya/pb3sol)

## pb3sol
- protobuf3 solidity code generator, inpired by https://github.com/shmookey/solpb (only supports pb2) enhanced with:
  - [soltype-pb](https://www.npmjs.com/package/soltype-pb), which enhances inter-operability with [protobuf.js](https://github.com/dcodeIO/ProtoBuf.js/)
  - support native solidity types like address, uint256, by including special protobuf definition [Solidity.proto](https://github.com/umegaya/pb3sol/blob/master/src/protoc/include/Solidity.proto)
- unimplemented protobuf feature
  - true enum generated by protobuf enum declaration. because solidity does not allow us to set arbiter values to enum declaration. 
  - float/double. no floating type in solidity. 



### Motivation
- recently, some kind of dapp like game need to treat complex, unstable data structure. 
- but for now, only solidity code can describe data structure and solidity code is immutable if it once deployed. 
 - actually, code can be replaced by [zos](https://zeppelinos.org/) or similar technology, but data related with old contract cannot move to new one automatically
- thus migrate data schema in smart contract is often with full database copy. its *un-acceptable* from the view point of performance and cost. 
- storing data as bytes and parse with protobuf could solve this problem with small increase of gas comsumption for each contract call, by separating actual data storage and its schema definition (replacable as solidity library)
- also, if we describe data as protobuf encoded byte array, contract only need to return byte array and parsing can be done on each client, which is huge save for contract code size and execution fee



### Try it out
- try to run test first. 
- easiest way to run test is to clone this repository and run ```make test_on_host```. There is a linux64 ```protoc``` binary, and other binaries could be downloaded via [protobuf](https://github.com/protocolbuffers/protobuf/releases).
- it does:
  - install necessary node module by using npm install
  - compile proto files to solidity source
  - run [truffle](http://truffleframework.com/) test
    - [create storage contract](https://github.com/umegaya/pb3sol/blob/master/test/contracts/libs/Storage.sol) (contract which just holds byte array with string key)
    - [store byte array encoded by protobuf](https://github.com/umegaya/pb3sol/blob/master/test/contracts/Version1.sol#L14)
    - [load byte array and decoded by protobuf](https://github.com/umegaya/pb3sol/blob/master/test/contracts/Version1.sol#L48)
    - [check encoded value is correctly restored](https://github.com/umegaya/pb3sol/blob/master/test/contracts/Version1.sol#L53)
    - [load byte array and decode on js side](https://github.com/umegaya/pb3sol/blob/master/test/test/v1_access.js#L76)
    - [decode it with new version of proto file and its correctly migreated](https://github.com/umegaya/pb3sol/blob/master/test/test/v1_access.js#L99)


### Basic Usage
- Check ```test/makefile``` for how to compile ```.proto``` to ```.sol```.
- for actually usage in solidity codes, see [here](https://github.com/umegaya/pb3sol/blob/master/test/contracts/Version1.sol) and [here](https://github.com/umegaya/pb3sol/blob/master/test/proto/TaskList.proto#L24)


### Handling native solidity type
- if you use docker image, built-in proto file "[Solidity.proto](https://github.com/umegaya/pb3sol/blob/master/src/protoc/include/Solidity.proto)" can import straight forward like ```import "Solidity.proto"```. then you can use ```.solidity.$typename``` to declare variable which directly convert to $typename variable in solidity codes. 
  - if you don't want to use docker, copy above file into somewhere in your proto compiler $path. 

- basically these solidity type is bytes variable boxed with message. but convert these bytes into correct number or bigint, is not trivial work. 
  - we create node module [soltype-pb](https://www.npmjs.com/package/soltype-pb) to add small support for handling these native solidity types with protobufjs.
  - installation to your project: ```npm install soltype-pb```
  - see [here](https://github.com/umegaya/pb3sol/blob/master/test/test/v1_access.js#L57) and [here](https://github.com/umegaya/pb3sol/blob/master/test/test/v1_access.js#L6) for usage.

